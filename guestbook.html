<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juan Tribaldos | Portfolio</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <canvas id="gbCanvas"></canvas>

    <header class="header-nav">
        <div class="custom-select-container">
            <div class="select-trigger">Guestbook</div>
            <ul class="select-options">
                <li data-value="index.html">Juan Tribaldos</li>
                <li data-value="about.html">About</li>
                <li data-value="contact.html">Contact</li>
                <li data-value="" disabled>Guestbook</li>
            </ul>
        </div>       

        <div class="custom-select-container">
            <div class="select-trigger">Interiores</div>
            <ul class="select-options">
                <li disabled>Interiores</li>
                <li data-value="/laurel-dd">Laurel DD</li>
                <li data-value="/casa-aromo">Casa Aromo</li>
                <li data-value="/casa-ikaros">Casa Ikaros</li>
                <li data-value="/casa-naia">Casa Naia</li>
                <li data-value="/casa-rosada">Casa Rosada</li>
                <li data-value="/casa-tula">Casa Tula</li>
                <li data-value="/perozah">Perozah</li>
            </ul>
        </div>

        <div class="custom-select-container">
            <div class="select-trigger">Exploraciones</div>
            <ul class="select-options">
                <li disabled>Exploraciones</li>
                <li data-value="/pleroma">Pl√©roma</li>
                <li data-value="/liminal">Liminal</li>
                <li data-value="/materia-prima">Materia Prima</li>
            </ul>
        </div>

        <div class="custom-select-container">
            <div class="select-trigger">Archivo</div>
            <ul class="select-options">
                <li disabled>Archivo</li>
                <li data-value="/art">Art</li>
                <li data-value="/residencia-salita-2025">Residencia Salita Temporal 2025</li>
            </ul>
        </div>
    </header>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHo5KM-RwA4fa0XeM_y3P66xZ9AGrwRUE",
            authDomain: "guestbook-jt.firebaseapp.com",
            databaseURL: "https://guestbook-jt-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "guestbook-jt",
            storageBucket: "guestbook-jt.firebasestorage.app",
            messagingSenderId: "676074383664",
            appId: "1:676074383664:web:7a5d5ddf4053268b30c0f5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'contenido_mundo');

        const FONT_SIZE = 20;
        const FONT_FACE = "Times New Roman, serif";
        
        class BackgroundGuestBook {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.cellW = 0;
                this.cellH = FONT_SIZE + 2;
                this.content = {}; 
                this.cursor = { x: 2, y: 5 };
                this.init();
            }

            init() {
                this.adjustSize();
                window.addEventListener('resize', () => this.adjustSize());
                onValue(dbRef, (snapshot) => {
                    this.content = snapshot.val() || {};
                    this.render();
                });

                window.addEventListener('keydown', (e) => {
                    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) e.preventDefault();
                    if (e.key.length === 1) this.write(e.key);
                    else this.handleSpecialKeys(e);
                });

                window.addEventListener('mousedown', (e) => {
                    // Evitar que el clic en los selectores mueva el cursor del canvas
                    if(!e.target.closest('.custom-select-container')) {
                        this.cursor.x = Math.floor(e.clientX / this.cellW);
                        this.cursor.y = Math.floor(e.clientY / this.cellH);
                        this.render();
                    }
                });
            }

            adjustSize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.ctx.font = `${FONT_SIZE}px ${FONT_FACE}`;
                this.cellW = this.ctx.measureText('m').width; 
                this.render();
            }

            handleSpecialKeys(e) {
                switch(e.key) {
                    case 'Backspace': this.moveCursor(-1, 0); this.saveToFirebase(this.cursor.x, this.cursor.y, null); break;
                    case 'Enter': this.cursor.x = 0; this.moveCursor(0, 1); break;
                    case 'ArrowLeft':  this.moveCursor(-1, 0); break;
                    case 'ArrowRight': this.moveCursor(1, 0); break;
                    case 'ArrowUp':    this.moveCursor(0, -1); break;
                    case 'ArrowDown':  this.moveCursor(0, 1); break;
                }
                this.render();
            }

            moveCursor(dx, dy) {
                this.cursor.x = Math.max(0, this.cursor.x + dx);
                this.cursor.y = Math.max(0, this.cursor.y + dy);
            }

            write(char) {
                this.saveToFirebase(this.cursor.x, this.cursor.y, char);
                this.moveCursor(1, 0);
            }

            saveToFirebase(x, y, char) {
                set(ref(db, 'contenido_mundo/' + `${x}_${y}`), char); 
            }

            render() {
                this.ctx.fillStyle = "#FFFED7";
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
                this.ctx.fillRect(this.cursor.x * this.cellW, this.cursor.y * this.cellH, this.cellW, this.cellH);
                this.ctx.fillStyle = "#000";
                this.ctx.font = `${FONT_SIZE}px ${FONT_FACE}`;
                this.ctx.textBaseline = "top";
                for (const [coord, char] of Object.entries(this.content)) {
                    const [x, y] = coord.split('_').map(Number);
                    if (char) this.ctx.fillText(char, x * this.cellW, y * this.cellH);
                }
            }
        }
        new BackgroundGuestBook('gbCanvas');
    </script>

    <script>
        document.querySelectorAll('.select-trigger').forEach(trigger => {
            trigger.addEventListener('click', (e) => {
                const options = trigger.nextElementSibling;
                document.querySelectorAll('.select-options').forEach(opt => {
                    if (opt !== options) opt.classList.remove('open');
                });
                options.classList.toggle('open');
                e.stopPropagation();
            });
        });

        document.querySelectorAll('.select-options li').forEach(option => {
            option.addEventListener('click', () => {
                const val = option.getAttribute('data-value');
                if (val && !option.hasAttribute('disabled')) window.location.href = val;
            });
        });

        window.addEventListener('click', () => {
            document.querySelectorAll('.select-options').forEach(opt => opt.classList.remove('open'));
        });
    </script>
</body>
</html>