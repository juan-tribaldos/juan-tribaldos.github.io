<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juan Tribaldos</title>
    <link rel="stylesheet" href="style.css">
    <!-- inline styles moved to /Users/canada_loft/Documents/GITHUB/juan-tribaldos.github.io/style.css -->
</head>
<body>

    <canvas id="gbCanvas"></canvas>

    <header class="header-nav">
        <div class="custom-select-container">
            <div class="select-trigger">Guestbook</div>
            <ul class="select-options">
                <li data-value="index.html">Juan Tribaldos</li>
                <li data-value="about.html">About</li>
                <li data-value="contact.html">Contact</li>                
            </ul>
        </div>       

        <div class="custom-select-container">
            <div class="select-trigger">Interiores</div>
            <ul class="select-options">
                <li data-value="/laurel-dd">Laurel DD</li>
                <li data-value="/casa-aromo">Casa Aromo</li>
                <li data-value="/casa-ikaros">Casa Ikaros</li>
                <li data-value="/casa-naia">Casa Naia</li>
                <li data-value="/casa-rosada">Casa Rosada</li>
                <li data-value="/casa-tula">Casa Tula</li>
                <li data-value="/perozah">Perozah</li>
            </ul>
        </div>

        <div class="custom-select-container">
            <div class="select-trigger">Exploraciones</div>
            <ul class="select-options">
                <li data-value="/pleroma">Pléroma</li>
                <li data-value="/liminal">Liminal</li>
                <li data-value="/materia-prima">Materia Prima</li>
            </ul>
        </div>

        <div class="custom-select-container">
            <div class="select-trigger">Archivo</div>
            <ul class="select-options">
                <li data-value="/art">Art</li>
                <li data-value="/residencia-salita-2025">Residencia Salita Temporal 2025</li>
            </ul>
        </div>
    </header>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBHo5KM-RwA4fa0XeM_y3P66xZ9AGrwRUE",
        authDomain: "guestbook-jt.firebaseapp.com",
        databaseURL: "https://guestbook-jt-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "guestbook-jt",
        storageBucket: "guestbook-jt.firebasestorage.app",
        messagingSenderId: "676074383664",
        appId: "1:676074383664:web:7a5d5ddf4053268b30c0f5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'contenido_mundo');

    const FONT_SIZE = 13;
    const KERNING = 2; // Ajuste de kerning solicitado
    const FONT_FACE = "Times New Roman, serif";
    const WORLD_SIZE = 300; // Extensión lógica del mundo para el minimapa

    class BackgroundGuestBook {
        constructor(canvasId) {
            this.canvas = document.getElementById(canvasId);
            this.ctx = this.canvas.getContext('2d');
            this.cellW = 0;
            this.cellH = FONT_SIZE + 4;
            this.content = {};
            this.cursor = { x: 5, y: 10 };
            this.offset = { x: 0, y: 0 };
            this.isMobile = window.matchMedia("(max-width: 600px)").matches;
            this.dragging = false;
            this.lastTouch = null;
            this.init();
        }

        init() {
            this.adjustSize();

            onValue(dbRef, (snapshot) => {
                this.content = snapshot.val() || {};
                this.render();
            });

            // ESCRIBIR: Usamos 'beforeinput' o 'keypress' para capturar caracteres ya procesados (acentos)
            window.addEventListener('keypress', (e) => {
                if (this.isMobile) return;
                // Evitamos capturar si el usuario está en un menú o input (si los hubiera)
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                
                this.write(e.key);
            });

            // TECLAS ESPECIALES
            window.addEventListener('keydown', (e) => {
                if (this.isMobile) return;
                if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight", "Backspace", "Enter"].includes(e.key)) {
                    this.handleSpecialKeys(e);
                }
            });

            // CLIC PARA POSICIONAR CURSOR
            window.addEventListener('mousedown', (e) => {
                if (this.isMobile) return;
                if(!e.target.closest('.custom-select-container')) {
                    const rect = this.canvas.getBoundingClientRect();
                    // Calculamos posición real sumando el desplazamiento (offset)
                    this.cursor.x = Math.round((e.clientX - rect.left) / this.cellW + this.offset.x);
                    this.cursor.y = Math.floor((e.clientY - rect.top) / this.cellH + this.offset.y);
                    this.render();
                }
            });

            // NAVEGACIÓN MÓVIL
            this.canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    this.dragging = true;
                    this.lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            }, { passive: true });

            this.canvas.addEventListener('touchmove', (e) => {
                if (this.dragging && e.touches.length === 1) {
                    const touch = e.touches[0];
                    const dx = touch.clientX - this.lastTouch.x;
                    const dy = touch.clientY - this.lastTouch.y;
                    this.offset.x -= dx / this.cellW;
                    this.offset.y -= dy / this.cellH;
                    this.lastTouch = { x: touch.clientX, y: touch.clientY };
                    this.render();
                }
            }, { passive: false });

            window.addEventListener('touchend', () => this.dragging = false);
            window.addEventListener('resize', () => this.adjustSize());
        }

        adjustSize() {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
            this.isMobile = window.matchMedia("(max-width: 600px)").matches;
            this.ctx.font = `${FONT_SIZE}px ${FONT_FACE}`;
            this.cellW = this.ctx.measureText('m').width + KERNING;
            this.render();
        }

        handleSpecialKeys(e) {
            if (e.key === 'Backspace') {
                e.preventDefault();
                this.moveCursor(-1, 0);
                this.saveToFirebase(this.cursor.x, this.cursor.y, null);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                this.cursor.x = 5; // Margen inicial
                this.moveCursor(0, 1);
            } else if (e.key.startsWith('Arrow')) {
                e.preventDefault();
                const moves = { ArrowLeft: [-1, 0], ArrowRight: [1, 0], ArrowUp: [0, -1], ArrowDown: [0, 1] };
                this.moveCursor(...moves[e.key]);
            }
            this.render();
        }

        moveCursor(dx, dy) {
            this.cursor.x = Math.max(0, this.cursor.x + dx);
            this.cursor.y = Math.max(0, this.cursor.y + dy);
        }

        write(char) {
            this.saveToFirebase(this.cursor.x, this.cursor.y, char);
            this.moveCursor(1, 0);
        }

        saveToFirebase(x, y, char) {
            set(ref(db, 'contenido_mundo/' + `${x}_${y}`), char);
        }

        drawMinimap() {
            const size = 150; // Tamaño visual del minimapa
            const padding = 20;
            const mx = this.canvas.width - size - padding;
            const my = this.canvas.height - size - padding;

            // Fondo y borde estilo "Select"
            this.ctx.fillStyle = "#ffffff";
            this.ctx.strokeStyle = "#000000";
            this.ctx.lineWidth = 1;
            this.ctx.fillRect(mx, my, size, size);
            this.ctx.strokeRect(mx, my, size, size);

            // Escala: Relación entre el tamaño del minimapa y el "mundo"
            const scale = size / WORLD_SIZE;

            // 1. Dibujar puntos de texto
            this.ctx.fillStyle = "#000";
            for (const coord in this.content) {
                const [cx, cy] = coord.split('_').map(Number);
                // Dibujamos el punto si entra en los límites del minimapa
                if (cx < WORLD_SIZE && cy < WORLD_SIZE) {
                    this.ctx.fillRect(mx + (cx * scale), my + (cy * scale), 2, 2);
                }
            }

            // 2. Dibujar visor (área visible actual)
            const visibleWidthCells = this.canvas.width / this.cellW;
            const visibleHeightCells = this.canvas.height / this.cellH;

            this.ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
            this.ctx.strokeStyle = "rgba(0, 0, 0, 0.4)";
            this.ctx.fillRect(
                mx + (this.offset.x * scale), 
                my + (this.offset.y * scale), 
                visibleWidthCells * scale, 
                visibleHeightCells * scale
            );
            this.ctx.strokeRect(
                mx + (this.offset.x * scale), 
                my + (this.offset.y * scale), 
                visibleWidthCells * scale, 
                visibleHeightCells * scale
            );
        }

        render() {
            this.ctx.fillStyle = "#FFFED7";
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

            // Dibujar caracteres
            this.ctx.fillStyle = "#000";
            this.ctx.font = `${FONT_SIZE}px ${FONT_FACE}`;
            this.ctx.textBaseline = "top";
            
            for (const [coord, char] of Object.entries(this.content)) {
                if (!char) continue;
                const [x, y] = coord.split('_').map(Number);
                const drawX = (x - this.offset.x) * this.cellW;
                const drawY = (y - this.offset.y) * this.cellH;
                
                // Optimización: solo dibujar lo que está en pantalla
                if (drawX > -20 && drawX < this.canvas.width + 20 && 
                    drawY > -20 && drawY < this.canvas.height + 20) {
                    this.ctx.fillText(char, drawX, drawY);
                }
            }

            // Cursor (solo escritorio)
            if (!this.isMobile) {
                this.ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
                this.ctx.fillRect(
                    (this.cursor.x - this.offset.x) * this.cellW, 
                    (this.cursor.y - this.offset.y) * this.cellH, 
                    this.cellW, 
                    this.cellH
                );
            }

            this.drawMinimap();
        }
    }
    new BackgroundGuestBook('gbCanvas');
</script>

    <script>
        document.querySelectorAll('.select-trigger').forEach(trigger => {
            trigger.addEventListener('click', (e) => {
                const options = trigger.nextElementSibling;
                document.querySelectorAll('.select-options').forEach(opt => {
                    if (opt !== options) opt.classList.remove('open');
                });
                options.classList.toggle('open');
                e.stopPropagation();
            });
        });

        document.querySelectorAll('.select-options li').forEach(option => {
            option.addEventListener('click', () => {
                const val = option.getAttribute('data-value');
                if (val && !option.hasAttribute('disabled')) window.location.href = val;
            });
        });

        window.addEventListener('click', () => {
            document.querySelectorAll('.select-options').forEach(opt => opt.classList.remove('open'));
        });
    </script>
</body>
</html>